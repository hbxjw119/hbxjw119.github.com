<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录个人的工作，生活，感悟..."><title>RabbitMQ 的简单使用 | JimmyXu的小站</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.9.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">RabbitMQ 的简单使用</h1><a id="logo" href="/.">JimmyXu的小站</a><p class="description">inner peace</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/study/"><i class="fa fa-book"> 宝典</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">RabbitMQ 的简单使用</h1><div class="post-meta">2018 年 03 月 16 日<span> | </span><span class="category"><a href="/categories/Tech/">Tech</a></span><span> | </span><span><i class="fa fa-file-word-o"></i></span><span class="post-count"> 2.7k 字</span><span> | </span><span><i class="fa fa-clock-o"></i></span><span class="post-count"> 阅读约需 10 分钟</span></div><div class="post-content"><p>在高性能，高可用，解耦的系统中，消息队列 ( Message Queue) 组件是少不了的。现在市面是有各种流行的 MQ 框架，比如 kafka，rabbitmq，roketmq，zeromq等。各个公司为了适应自己业务的发展，有的会自己造轮子，而有的则在开源消息队里的基础上，做了进一步的改造和优化。本文使用 rabbitmq，作为消息队列的入门使用。<br><a id="more"></a></p>
<h2 id="什么是消息队列"><a href="#什么是消息队列" class="headerlink" title="什么是消息队列"></a>什么是消息队列</h2><p>使用 rabbitmq 之前，先说说什么是消息队列。我们为什么要用消息队列呢？可以用日常网购的场景来做对比。如我们在网上下了个单，我们不会坐着等商品到达。而商家发货后，也不会坐着等我们收到商品的消息。商家会把你的商品，发给快递公司，然后继续接收其他用户的订单。对于商家来说，他的工作已经做完了。而快递公司，则会把我们的商品准确发给我们。这样的方式，使商家和我们买家之间解耦，对于商家来说，他能处理更多的订单请求，而我们消费者，则可以在收到快递到达的通知时才去取。</p>
<h2 id="rabbitmq-中的几个概念"><a href="#rabbitmq-中的几个概念" class="headerlink" title="rabbitmq 中的几个概念"></a>rabbitmq 中的几个概念</h2><p>rabbitmq 也是类似的原理，在 rabbitmq 中，有几个重要的组件，<code>publisher</code>，即生产者，是产生消息的一方，类似于商家，<code>exchange</code>，交换器，生产者会把消息发往<code>exchange</code>，作用相当于快递公司，<code>queue</code>，队列，接收<code>exchange</code>发过来的消息，相当于运输快递的交通工具，<code>consumer</code>，消费者，消息的接收方，也就是我们买家。在这个里面可以看到，生成者并不是直接将消息投到队列中的，需要经过一个交换器，交换器负责把消息路由到某个或者多个队列。</p>
<p>另一个比较重要的概念就是交换器类型，可以这么理解，中通快递公司，只会把商品放到中通快递的运输车上传递，而不能放到其他公司的运输车上。各个快递公司，也都只能把商品放到各自公司的车上。rabbitmq 中的交换器做的也是类似的事，它定义了一些规则，根据规则，rabbitmq就会把消息投递到指定的队列。这些规则称为路由键。交换器有四种类型：<code>direct</code>, <code>topic</code>, <code>fanout</code>，<code>headers</code>，每种类型实现了不通的路由算法。</p>
<ul>
<li><code>direct</code>: 这种交换器比较简单，它的路由规则是一个完全匹配模式，当它绑定了A队列，那么以后这个交换器中的消息，都会投递到A队列中。</li>
<li><code>topic</code>: 这种交换器的路由规则，可以使来自不同源头的消息到达同一个队列。比如不同级别的日志消息(info-log, warn-log, error-log) 都投递到 log 队列。</li>
<li><code>fanout</code>: 这种交换器类似广播模式，它会把收到的信息，广播到绑定到它身上的所有队列中。</li>
<li><code>header</code>: 匹配 AMQP 消息的 header 而非路由键，不太实用，或者基本不使用。</li>
</ul>
<p>有了以上概念，我们就可以搞一些事了。</p>
<h2 id="rabbitmq-的安装"><a href="#rabbitmq-的安装" class="headerlink" title="rabbitmq 的安装"></a>rabbitmq 的安装</h2><p>首先是安装，在 CentOS 上安装 rabbitmq 非常简单，一行命令搞定<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install rabbitmq-server</span><br></pre></td></tr></table></figure></p>
<p>安装完毕后，直接启动服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service rabbitmq-server start</span><br></pre></td></tr></table></figure></p>
<p>启动完毕，就可以使用<code>rabbitmqctl</code>命令，对 rabbitmq 进行一系列操作，如查看 rabbitmq 的状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl status</span><br></pre></td></tr></table></figure></p>
<h2 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h2><p>考虑下有这样一个应用：它允许用户上传图片，当用户上传图片后，可以获得一定的积分，同时用户的好友，可以收到收到通知。你可以把这样的功能写成一个流程<br>upload_img -&gt; add_user_point -&gt; notify_others -&gt; success<br>形如<br><img src="/images/rabbitmq/p1.png" alt="方式1"></p>
<p>但这样带来的坏处是，当需求变更，不得不直接修改你的业务逻辑。如 pm 认为上传原始图片太占带宽，让你在上传图片前，先做压缩处理。或者在后面，添加记录日志的操作。每次修改，都不得不修改原来的代码。最终变得不可维护。另一方面就是性能问题，当有大量用户上传图片时，你的系统可能就不堪承受，最终服务不可用。问题就出在，这样的设计是强耦合的，增加积分，通知好友这些操作，不应该依赖于上传图片。需要把上传图片、增加积分、通知好友当做三个独立的服务，然后用一个桥梁，把三者再结合起来，达到解耦的目的，如下图所示。<br><img src="/images/rabbitmq/p2.png" alt="方式2"><br>这样，首先可以把工作量拆分，一个人写上传图片服务，一个人写增加用户积分服务，当有其他新增服务时，简单的接入即可。另一方面，当你的某个服务压力过大时，粗暴的继续加机器部署服务即可解决。下面通过一个简单的例子，来看看如何使用 rabbitmq 来拆分完成上述上传图片的需求。</p>
<ol>
<li><p>首先写上传图片服务，注释已经说明了问题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//命令行参数，模拟用户上传图片的请求</span></span><br><span class="line">$image_id = $argv[<span class="number">1</span>];</span><br><span class="line">$user_id = $argv[<span class="number">2</span>];</span><br><span class="line">$image_path = $argv[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//连接到rabbit</span></span><br><span class="line">$conn = <span class="keyword">new</span> AMQPConnection(HOST, PORT, USER, PASS, VHOST);</span><br><span class="line"><span class="comment">//指定一个信道</span></span><br><span class="line">$channel = $conn-&gt;channel();</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明一个名为 upload-pictures 的交换器，类型是 fanout 模式, 后面的参数请参考api</span></span><br><span class="line">$channel-&gt;exchange_declare(<span class="string">'upload-pictures'</span>, <span class="string">'fanout'</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将用户请求组装成一个消息</span></span><br><span class="line">$metadata = json_encode(<span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'image_id'</span> =&gt; $image_id,</span><br><span class="line">        <span class="string">'user_id'</span> =&gt; $user_id,</span><br><span class="line">        <span class="string">'image_path'</span> =&gt; $image_path</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">$msg = <span class="keyword">new</span> AMQPMessage($metadata,</span><br><span class="line">                <span class="keyword">array</span>(<span class="string">'content_type'</span> =&gt; <span class="string">'application/json'</span>,</span><br><span class="line">                        <span class="string">'delivery_mode'</span> =&gt; <span class="number">2</span>));</span><br><span class="line"><span class="comment">//投递消息到 upload-pictures 交换器</span></span><br><span class="line">$channel-&gt;basic_publish($msg, <span class="string">'upload-pictures'</span>);</span><br><span class="line"></span><br><span class="line">$channel-&gt;close();</span><br><span class="line">$conn-&gt;close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>增加用户积分的服务，注释已经说明了问题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="comment">//获得rabbit连接和信道</span></span><br><span class="line">$conn = <span class="keyword">new</span> AMQPConnection(HOST, PORT, USER, PASS, VHOST);</span><br><span class="line">$channel = $conn-&gt;channel();</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟增加用户积分的逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add_points_to_user</span><span class="params">($user_id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> sprintf(<span class="string">"Adding points to user: %s\n"</span>, $user_id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明交换器</span></span><br><span class="line">$channel-&gt;exchange_declare(<span class="string">'upload-pictures'</span>, <span class="string">'fanout'</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="comment">//声明了一个 add-user-point 的队列</span></span><br><span class="line">$channel-&gt;queue_declare(<span class="string">'add-user-point'</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"><span class="comment">//绑定队列到交换器</span></span><br><span class="line">$channel-&gt;queue_bind(<span class="string">'add-user-point'</span>, <span class="string">'upload-pictures'</span>);</span><br><span class="line"><span class="comment">//创建回调函数</span></span><br><span class="line">$consumer = <span class="function"><span class="keyword">function</span><span class="params">($msg)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($msg-&gt;body == <span class="string">'quit'</span>)&#123;</span><br><span class="line">        $msg-&gt;delivery_info[<span class="string">'channel'</span>]-&gt;</span><br><span class="line">            basic_cancel($msg-&gt;delivery_info[<span class="string">'consumer_tag'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $meta = json_decode($msg-&gt;body, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    add_points_to_user($meta[<span class="string">'user_id'</span>]);</span><br><span class="line"></span><br><span class="line">    $msg-&gt;delivery_info[<span class="string">'channel'</span>]-&gt;</span><br><span class="line">        basic_ack($msg-&gt;delivery_info[<span class="string">'delivery_tag'</span>]);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//准备消费者</span></span><br><span class="line">$channel-&gt;basic_consume($queue,</span><br><span class="line">    $consumer_tag,</span><br><span class="line">    <span class="keyword">false</span>,</span><br><span class="line">    <span class="keyword">false</span>,</span><br><span class="line">    <span class="keyword">false</span>,</span><br><span class="line">    <span class="keyword">false</span>,</span><br><span class="line">    $consumer);</span><br><span class="line"><span class="comment">//等待消息到达</span></span><br><span class="line"><span class="keyword">while</span>(count($channel-&gt;callbacks)) &#123;</span><br><span class="line">    $channel-&gt;wait();</span><br><span class="line">&#125;</span><br><span class="line">$channel-&gt;close();</span><br><span class="line">$conn-&gt;close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建通知朋友的服务，类比于增加用户积分</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$conn = <span class="keyword">new</span> AMQPConnection(HOST, PORT, USER, PASS, VHOST);</span><br><span class="line">$channel = $conn-&gt;channel();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">notify_friend</span><span class="params">($user_id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> sprintf(<span class="string">"notified user's %s friend: %s\n"</span>,</span><br><span class="line">        $user_id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$channel-&gt;exchange_declare(<span class="string">'upload-pictures'</span>, <span class="string">'fanout'</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">$channel-&gt;queue_declare(<span class="string">'notify-user'</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">$channel-&gt;queue_bind(<span class="string">'notify-user'</span>, <span class="string">'upload-pictures'</span>);</span><br><span class="line"></span><br><span class="line">$consumer = <span class="function"><span class="keyword">function</span><span class="params">($msg)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($msg-&gt;body == <span class="string">'quit'</span>)&#123;</span><br><span class="line">        $msg-&gt;delivery_info[<span class="string">'channel'</span>]-&gt;</span><br><span class="line">            basic_cancel($msg-&gt;delivery_info[<span class="string">'consumer_tag'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    $meta = json_decode($msg-&gt;body, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    notify_friend($meta[<span class="string">'user_id'</span>]);</span><br><span class="line">    $msg-&gt;delivery_info[<span class="string">'channel'</span>]-&gt;</span><br><span class="line">        basic_ack($msg-&gt;delivery_info[<span class="string">'delivery_tag'</span>]);</span><br><span class="line">&#125;;</span><br><span class="line">$channel-&gt;basic_consume($queue,</span><br><span class="line">    $consumer_tag,</span><br><span class="line">    <span class="keyword">false</span>,</span><br><span class="line">    <span class="keyword">false</span>,</span><br><span class="line">    <span class="keyword">false</span>,</span><br><span class="line">    <span class="keyword">false</span>,</span><br><span class="line">    $consumer);</span><br><span class="line"><span class="keyword">while</span>(count($channel-&gt;callbacks)) &#123;</span><br><span class="line">    $channel-&gt;wait();</span><br><span class="line">&#125;</span><br><span class="line">$channel-&gt;close();</span><br><span class="line">$conn-&gt;close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>很明显，上述中，上传图片服务是生产者，增加用户积分，通知消息两个是消费者。当后续有更多的服务需要加入时，只需要依葫芦画瓢，继续添加到 rabbitmq 中消费即可。而假如某个服务负载较高，需要更多的计算能力，也不必修改代码，只需要启动更多的消费者进程即可，而 rabbitmq 会负责对消息进行分发。</p>
<h2 id="组建-rabbitmq-集群和镜像队列"><a href="#组建-rabbitmq-集群和镜像队列" class="headerlink" title="组建 rabbitmq 集群和镜像队列"></a>组建 rabbitmq 集群和镜像队列</h2><p>加入了 rabbitmq 的系统架构，系统的稳定性也同样依赖消息队列。如果消息系统挂了，整个系统也不可用，组建集群是解决方法之一。rabbitmq 组建集群也非常容易，假如有两台机器：srv01（192.168.1.10），srv02（192.168.1.11）。</p>
<ul>
<li>分别在两台机器上安装 rabbitmq 并成功启动</li>
<li><p>为了让两台机器的 rabbitmq 正常通信，拷贝 srv01 的 erlang cookie 到 srv02，一般在<code>/var/lib/rabbitmq/.erlang.cookie</code>，重启 srv02 上的 rabbitmq 进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service rabbitmq-server restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止 srv02 上的 rabbitmq 应用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br></pre></td></tr></table></figure>
</li>
<li><p>重设 srv02 上的元数据和状态为清空状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl reset</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 srv02 节点加入到第一个节点，<strong>这里需要注意，@ 后面写的是节点的 hostname，但实际 rabbit 是通过 IP 和节点通信的，因此，需要将 hostname 和 IP 做映射，在 srv02 机器上的 /etc/hosts 文件中，追加 192.168.1.10 srv01。 如果直接在 @ 后面写 srv01 的 IP 是无效的</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl join_cluster rabbit@srv01</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新启动 srv02 节点的 rabbit</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看 rabbitmq 集群状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如果在 nodes 节点信息中，看到有 rabbit@srv01, rabbit@srv02 字样，说明两个节点的集群已经配置完毕。</p>
<h3 id="镜像队列"><a href="#镜像队列" class="headerlink" title="镜像队列"></a>镜像队列</h3><p>有了 rabbitmq 集群后，消息系统就高可用了吗？并不是，rabbitmq 集群只是一种伪高可用，实际上，集群中的多个节点之间，只会同步元数据，比如 exchange 元数据，queue 元数据等，但并不会同步队列的内容，一般情况下，很少单纯的使用集群模式，而是用镜像队列。这种方式下，每个节点都保存有所有的队列，无论元数据还是 queue 里的消息都会存在于多个实例上，就是说，每个 rabbitmq 节点都有这个 queue 的一个完整镜像，包含 queue 的全部数据。写消息到 queue 的时候，都会自动把消息同步到多个实例的 queue 上，生产环境下，都会用镜像队列模式。</p>
<p>配置镜像队列也不困难，接着上面集群模式，执行一条命令即可<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_policy mirror_queue <span class="string">"^"</span> <span class="string">'&#123;"ha-mode":"all","ha-sync-mode":"automatic"&#125;'</span></span><br></pre></td></tr></table></figure></p>
<p>这是给 rabbitmq 增加了一条策略，其中，mirror_queue 是起的名字，可任意，<code>^</code>是匹配规则，表示对匹配这些规则的 queue 做操作，操作就是后面的字符串，字符串是 k-v 形式，详细含义，可以参考 rabbitmq <a href="https://www.rabbitmq.com/ha.html" target="_blank" rel="noopener">官方链接</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>由以上的简单例子可以看出，使用消息队列，可以很方便的将系统解耦，使系统有良好的扩展性。rabbitmq 是一个高性能的消息队列组件，使用和搭建集群也是非常方便的。<br>本文完整的实例代码，可以在<a href="https://github.com/hbxjw119/learnbylearn/tree/master/rabbitmq/php/img-upload" target="_blank" rel="noopener">这里</a>找到。</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li>《RabbitMQ 实战》</li>
<li><a href="https://www.rabbitmq.com/ha.html" target="_blank" rel="noopener">https://www.rabbitmq.com/ha.html</a></li>
<li><a href="https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/how-to-ensure-high-availability-of-message-queues.md" target="_blank" rel="noopener">https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/how-to-ensure-high-availability-of-message-queues.md</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.9.0" async></script><a class="article-share-link" data-url="http://xujimmy.com/2018/03/16/start-rabbitmq.html" data-id="ckpxdut4d0032e2kwc4mcyokn" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMklEQVR42u3aQY6DQAxE0dz/0hlptijwyyajwf6sokiBfiwqdrtfL3y9f69Pn/l1/NXxKcfvb7tkyJDxWAZ/8Dks/Ya/svO1yZAhYw+jdjtyBxKs5PPFmmXIkCHjdCm8BLwITRkyZMi4KXBJdPII7kS5DBkytjF4dKbbZGmT/PVeXIYMGQ9k9AcD3/v8p/MNGTJk/EtGfwBZi0IS3MGqZMiQMZpBxpPp2DJtg89LT97WypAhYyoj3aYn3/MhJX8RFyEuQ4aM0QxSlpFirnOQgsc9anFlyJAxjlEbA9Ra2dqoEoW1DBkyFjDibMbbZ7VCkJSkMmTI2MngW121h/FWOS0uZciQsYGRtpF8My4tMdMDHzJkyNjAIC1rZ2CQhnhrYCBDhowFDH78gi+Fhy95iShwZciQsYbBD2TwkWSnoUVlqwwZMoYyOgPIdDDQ3577SJIhQ8ZoRq0IC8q1MMQ7r1KGDBmzGXyjrVZ78hit/QHIkCFjAyM98hX8uLShxhvj1uNlyJDxEAaqGTGsFotpiKPtNhkyZIxjkBKNLKLWAPNW9mPJKEOGjNGMWux2Rp6dclOGDBk7Ge/w6kRqGtnBQTEZMmSMZqSbZa1cb2zA1e4vQ4aMSYy7QvauuQQ/FobeogwZMgYxyJY9b01rY04e+hfjARkyZCxm1MKRRGdaycqQIUMGaSb5oYrO2DJ4ogwZMhYwSBObPoDHaJ8qQ4aM2YzaYIAA+OL4C+XDURkyZIxg/ABOL/AuNI3XQgAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/消息队列/">消息队列</a><a href="/tags/MQ/">MQ</a></div><div class="article-footer-copyright"><p>本文由 JimmyXu 发表，采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh">署名-非商业性使用-禁止演绎4.0</a>进行许可</p><p>非商业转载请注明作者及出处，商业转载请联系作者本人</p><p>本文标题: RabbitMQ 的简单使用</p><p>本文链接: <a href="http://xujimmy.com/2018/03/16/start-rabbitmq.html">http://xujimmy.com/2018/03/16/start-rabbitmq.html</a></p></div><div class="post-nav"><a class="pre" href="/2018/03/22/about-mathematical-formula.html">数学上的一些经典片段</a><a class="next" href="/2018/01/22/about-csdn.html">CSDN 的困境</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.9.0"><script src="/js/gitment.browser.js?v=0.9.0"></script><script>var gitment = new Gitment({
  owner: 'hbxjw119',
  repo: 'hbxjw119.github.io',
  oauth: {
    client_id: '6cc8e017eb97ff6696f8',
    client_secret: '042c585d7da96a9f11048ec8bdedd79920c00890',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Blog/">Blog</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Life/">Life</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tech/">Tech</a><span class="category-list-count">39</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/gevent/" style="font-size: 15px;">gevent</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/monitor/" style="font-size: 15px;">monitor</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/xargs/" style="font-size: 15px;">xargs</a> <a href="/tags/PhantomJS/" style="font-size: 15px;">PhantomJS</a> <a href="/tags/sort/" style="font-size: 15px;">sort</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/grep/" style="font-size: 15px;">grep</a> <a href="/tags/awk/" style="font-size: 15px;">awk</a> <a href="/tags/influxdb/" style="font-size: 15px;">influxdb</a> <a href="/tags/grafana/" style="font-size: 15px;">grafana</a> <a href="/tags/design-pattern/" style="font-size: 15px;">design pattern</a> <a href="/tags/Cookie/" style="font-size: 15px;">Cookie</a> <a href="/tags/Session/" style="font-size: 15px;">Session</a> <a href="/tags/shell/" style="font-size: 15px;">shell</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/zsh/" style="font-size: 15px;">zsh</a> <a href="/tags/公众号/" style="font-size: 15px;">公众号</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/tcp/" style="font-size: 15px;">tcp</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/httpie/" style="font-size: 15px;">httpie</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/lnmp/" style="font-size: 15px;">lnmp</a> <a href="/tags/北京/" style="font-size: 15px;">北京</a> <a href="/tags/fpm/" style="font-size: 15px;">fpm</a> <a href="/tags/find/" style="font-size: 15px;">find</a> <a href="/tags/go/" style="font-size: 15px;">go</a> <a href="/tags/algorithm/" style="font-size: 15px;">algorithm</a> <a href="/tags/面试/" style="font-size: 15px;">面试</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/acme/" style="font-size: 15px;">acme</a> <a href="/tags/阿里云/" style="font-size: 15px;">阿里云</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/记账/" style="font-size: 15px;">记账</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/maupassant/" style="font-size: 15px;">maupassant</a> <a href="/tags/配置/" style="font-size: 15px;">配置</a> <a href="/tags/vps/" style="font-size: 15px;">vps</a> <a href="/tags/shadowsocks/" style="font-size: 15px;">shadowsocks</a> <a href="/tags/bbr/" style="font-size: 15px;">bbr</a> <a href="/tags/云计算/" style="font-size: 15px;">云计算</a> <a href="/tags/csdn/" style="font-size: 15px;">csdn</a> <a href="/tags/消息队列/" style="font-size: 15px;">消息队列</a> <a href="/tags/MQ/" style="font-size: 15px;">MQ</a> <a href="/tags/math/" style="font-size: 15px;">math</a> <a href="/tags/公式/" style="font-size: 15px;">公式</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/分布式系统/" style="font-size: 15px;">分布式系统</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/同步/" style="font-size: 15px;">同步</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/collection/" style="font-size: 15px;">collection</a> <a href="/tags/虚拟机/" style="font-size: 15px;">虚拟机</a> <a href="/tags/KVM/" style="font-size: 15px;">KVM</a> <a href="/tags/异步任务/" style="font-size: 15px;">异步任务</a> <a href="/tags/随想/" style="font-size: 15px;">随想</a> <a href="/tags/select/" style="font-size: 15px;">select</a> <a href="/tags/epoll/" style="font-size: 15px;">epoll</a> <a href="/tags/BIO/" style="font-size: 15px;">BIO</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/openstack/" style="font-size: 15px;">openstack</a> <a href="/tags/k8s/" style="font-size: 15px;">k8s</a> <a href="/tags/schedule/" style="font-size: 15px;">schedule</a> <a href="/tags/资源调度/" style="font-size: 15px;">资源调度</a> <a href="/tags/pxe/" style="font-size: 15px;">pxe</a> <a href="/tags/ipmi/" style="font-size: 15px;">ipmi</a> <a href="/tags/dnsmasq/" style="font-size: 15px;">dnsmasq</a> <a href="/tags/dhcp/" style="font-size: 15px;">dhcp</a> <a href="/tags/CPU/" style="font-size: 15px;">CPU</a> <a href="/tags/缓存/" style="font-size: 15px;">缓存</a> <a href="/tags/计算机系统/" style="font-size: 15px;">计算机系统</a> <a href="/tags/protobuf/" style="font-size: 15px;">protobuf</a> <a href="/tags/rpc/" style="font-size: 15px;">rpc</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/二进制/" style="font-size: 15px;">二进制</a> <a href="/tags/操作系统/" style="font-size: 15px;">操作系统</a> <a href="/tags/虚拟内存/" style="font-size: 15px;">虚拟内存</a> <a href="/tags/book/" style="font-size: 15px;">book</a> <a href="/tags/书单/" style="font-size: 15px;">书单</a> <a href="/tags/艺术，美术，个人/" style="font-size: 15px;">艺术，美术，个人</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/29/about-painting-arts.html">谈谈美术绘画</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/12/introduction-virtual-memory.html">虚拟内存简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/22/poison-detect.html">由病毒检测想到的一种面试题</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/11/use-proto.html">使用 protobuf</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/29/computer-memory.html">程序员需要知道的数量级</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/11/schedule-in-cloud.html">云计算中的资源调度</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/21/pxe-install-os.html">使用 PXE 从网络安装操作系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/27/what-is-io-multiplexing.html">什么是 I/O 多路复用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/29/java-Future-and-Executor.html">Java 中 Future 和异步任务</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/23/git-pull-and-git-rebase.html">git pull 和 git rebase</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.coolguy.pw/" title="coolguy" target="_blank">coolguy</a><ul></ul><a href="https://timyang.net/" title="Tim's blog" target="_blank">Tim's blog</a><ul></ul><a href="https://coolshell.cn/" title="酷壳" target="_blank">酷壳</a><ul></ul><a href="https://toutiao.io/" title="开发者头条" target="_blank">开发者头条</a><ul></ul><a href="https://huoding.com/" title="火丁笔记" target="_blank">火丁笔记</a><ul></ul><a href="http://blog.guoyb.com/" title="笨茄子" target="_blank">笨茄子</a><ul></ul><a href="https://mengkang.net/" title="周孟康" target="_blank">周孟康</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">JimmyXu的小站 |</a> <a rel="nofollow" target="_blank" href="http://www.miitbeian.gov.cn/">京ICP备 17056410 号 | </a> Powered by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho</a><div><i class="fa fa-eye"><span class="visitors"></span></i></div></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.9.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.9.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.9.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = '//hm.baidu.com/hm.js?b24b1cbb03fdc613791573423619f3e3';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.9.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.9.0"></script><script type="text/javascript" src="//xujimmy.oss-cn-beijing.aliyuncs.com/av-min.js"></script><script type="text/javascript" src="/js/leandcnt.js?v=0.9.0"></script><script>visitorCount('phNBe6j30h7xFUszRWcBTCIi-gzGzoHsz', '0MKEk5HhPkcT27ogNF4tNhQA', '5a1e63f58d6d8100628a225e')</script></div></body></html>