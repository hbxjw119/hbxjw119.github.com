<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>Java 中 Future 和异步任务 | JimmyXu的小站</title>
    <meta property="og:title" content="Java 中 Future 和异步任务 - JimmyXu的小站">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-05-29T16:12:40&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-05-29T16:12:40&#43;08:00'>
        
    <meta name="Keywords" content="博客,Web,软件,互联网">
    <meta name="description" content="Java 中 Future 和异步任务">
        
    <meta name="author" content="JimmyXu">
    <meta property="og:url" content="http://xujimmy.com/2019/05/29/java-future-and-executor.html">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://xujimmy.com">
                        JimmyXu的小站
                    </a>
                
                <p class="description">inner peace</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://xujimmy.com">首页</a>
                    
                    <a  href="http://xujimmy.com/archives.html" title="归档">归档</a>
                    
                    <a  href="http://xujimmy.com/about.html" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#heading">一个案例</a></li>
    <li><a href="#future-">Future 是什么</a>
      <ul>
        <li><a href="#future-1">Future 中的方法</a></li>
        <li><a href="#-runnable-">执行 Runnable 任务</a></li>
      </ul>
    </li>
    <li><a href="#executorcompletionservice">ExecutorCompletionService</a></li>
    <li><a href="#heading1">总结</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">Java 中 Future 和异步任务</h1>
        </header>
        <date class="post-meta meta-date">
            2019年5月29日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/tech'>Tech</a></span>
            
        </div>
        
        
        
                    <span class="post-meta">| 3995 字</span><span class="post-meta"> | 阅读约 8 分钟</span>
            
        
        <div class="post-content">
            <p>Java 中的多线程技术一直是个热门话题，而线程池、异步任务是多线程编程中绕不开的一个技术要点，本文介绍下 java 中的 Future 相关使用方法以及任务执行框架 ExecutorService。</p>
<h2 id="heading">一个案例</h2>
<p>先看一个案例：用多线程输出 1 亿内的所有质数，并要求输出的质数顺序是排好序的。</p>
<p>如果单纯要完成质数输出，有很多方式，比如将 1 亿数字平均分为 100 份，每份 100 万个，用 100 个线程分别求解质数，每个线程的 run 函数里，打印质数。我们写下这样的代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PrimeDemo</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[</span><span style="color:#f92672">]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> start <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> end   <span style="color:#f92672">=</span> 100000000<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> start<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> end<span style="color:#f92672">;</span> i <span style="color:#f92672">+</span><span style="color:#f92672">=</span> 1000000<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> subList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> i<span style="color:#f92672">;</span> j <span style="color:#f92672">&lt;</span> i <span style="color:#f92672">+</span> 1000000<span style="color:#f92672">;</span> j<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                subList<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>j<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#75715e">// 创建线程打印质数
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PrimeThread<span style="color:#f92672">(</span>subList<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PrimeThread</span> <span style="color:#66d9ef">implements</span> Runnable <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> list<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">PrimeThread</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> list<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">list</span> <span style="color:#f92672">=</span> list<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    	<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Integer i <span style="color:#f92672">:</span> list<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isPrime<span style="color:#f92672">(</span>i<span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>i<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isPrime</span><span style="color:#f92672">(</span>Integer num<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>num <span style="color:#f92672">=</span><span style="color:#f92672">=</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>num <span style="color:#f92672">&lt;</span> 2 <span style="color:#f92672">|</span><span style="color:#f92672">|</span> num <span style="color:#f92672">%</span> 2 <span style="color:#f92672">=</span><span style="color:#f92672">=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span> <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 3<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">sqrt</span><span style="color:#f92672">(</span>num<span style="color:#f92672">)</span><span style="color:#f92672">;</span> i <span style="color:#f92672">+</span><span style="color:#f92672">=</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>num <span style="color:#f92672">%</span> i <span style="color:#f92672">=</span><span style="color:#f92672">=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>我们发现，Runnable 中的 run 返回是 void，也就是说，每个线程只能输出结果，而没办法返回结果，因此最终的输出是无序的。有没有办法把这个结果返回呢？答案是肯定的，我们可以用 Callable</p>
<p>Callable 和 Runnable 的功能类似，但有 3 个不同点：
1、Callable 中的 call 是泛型方法，并且有返回值，也会抛出异常，需要对异常进行处理
2、Callable 不像 Runnable 可以直接用来 new Thread(new Runnable) 开一个线程，Callable 一般配合线程池使用
3、向线程池提交一个 Callable 任务后， 线程池并不是直接给我们返回任务的结果，而是返回一个 Future，通过这个 Future，我们才可以拿到执行结果。</p>
<h2 id="future-">Future 是什么</h2>
<p>看了上面的描述，可能有同学还是不太理解 Future 是什么，从字面意来看，它是&quot;将来&rdquo;，但这太抽象了，事实确实如此，从 Future 的源码来看，它是一个接口，接口就是抽象的，它表示的是一个任务的执行情况。为了帮助理解，我们可以把它和<strong>句柄</strong>，或者文件描述符（fd）做类比，假如我们要对文件或者网络设备进行读写，通常会拿到一个句柄，文件的话，通常是文件句柄，网络的话，通常是 socket，调用句柄的 read 和 write 方法即可对文件或 socket 进行读写，类比过来，Future 就是一个表示<strong>任务的句柄</strong>，通过这个“句柄”，我们可以获得任务的执行情况，以及给任务发送一些指令。用一个简单例子来体会下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FutureDemo</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[</span><span style="color:#f92672">]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 创建一个固定大小的线程池
</span><span style="color:#75715e"></span>        ExecutorService executor <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newFixedThreadPool</span><span style="color:#f92672">(</span>10<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        String name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;jimmy&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// 用 submit 方法，向线程池提交一个 Callable 任务，submit 返回一个 Future，也就是标识该任务的&#34;句柄&#34;
</span><span style="color:#75715e"></span>        Future<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> executor<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> UpperStringTask<span style="color:#f92672">(</span>name<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// get 方法，获取任务的执行结果，如果任务执行过程中出错，会抛出 ExecutionException 异常
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>future<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>    
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ExecutionException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UpperStringTask</span> <span style="color:#66d9ef">implements</span> Callable<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">PrimeTask</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> name<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// 重写 call 方法，并返回 String
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">call</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> name<span style="color:#f92672">.</span><span style="color:#a6e22e">toUpperCase</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>上面的例子是一个很简单的示例，Callable 里执行的也是很简单的任务：将一个字符串转为大写，并返回。返回的结果，可以通过 future.get() 方法获得。可以看到，Callable 的使用方式和 Runnable 基本类似：Runnable 重写 run 方法，Callable 重写 call 方法。这里关键的地方在于，我们不是通过 new 一个 Thread 来启动任务，而是用 ExecutorService 的 submit 方法提交任务，submit 方法返回的也只是 Future，即一个任务的“句柄”，而不是任务结果本身。需要通过 Future 的 get 方法来获得任务结果。如果执行失败或者上面例子，就是将字符串 “jimmy” 转为大写的结果。由于任务的 call 方法返回的是 String 类型，因此 future 也应该是 String，即 <code>Future&lt;String&gt;</code> 。需要提醒的是，get 方法是个阻塞方法，这意味着，如果任务比较耗时，则 get 会一直等待任务执行完成才返回。</p>
<h3 id="future-1">Future 中的方法</h3>
<p>除了 get 方法获得任务执行结果，Future 还有其他方法，如</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 判断操作是否已经完成，包括了正常完成、异常抛出、取消
</span><span style="color:#75715e"></span>future<span style="color:#f92672">.</span><span style="color:#a6e22e">isDone</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>

<span style="color:#75715e">// 取消操作，方式是中断。参数 true 说的是，即使这个任务正在执行，也会进行中断
</span><span style="color:#75715e"></span>future<span style="color:#f92672">.</span><span style="color:#a6e22e">cancel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>

<span style="color:#75715e">// 是否被取消，只有在任务正常结束之前被取消，这个方法才会返回 true
</span><span style="color:#75715e"></span>future<span style="color:#f92672">.</span><span style="color:#a6e22e">isCancelled</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span>

<span style="color:#75715e">// 上面不带参数的 get 方法是阻塞的，会一直等待任务执行完成，也可以给 get 传一个参数，设置超时时间
</span><span style="color:#75715e"></span>future<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>timeout<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">)</span>
</code></pre></div><p>可以看到，确实可以把 Futuere 想象成任务的句柄，通过这个句柄，获得任务的状态，以及对任务做一些操作。这一点上，Callable 要比 Runnable 灵活许多。</p>
<p>弄明白了上面简单例子，我们就可以尝试解决文章开头的那个案例了，注释已经说明了问题</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PrimeDemo</span> <span style="color:#f92672">{</span>
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[</span><span style="color:#f92672">]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">// 创建一个固定大小的线程池
</span><span style="color:#75715e"></span>        ExecutorService executor <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newFixedThreadPool</span><span style="color:#f92672">(</span>100<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">// 表示一批任务执行情况的 future 集合，每个任务的结果是 List&lt;Integer&gt;
</span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>Future<span style="color:#f92672">&lt;</span>List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> futures <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        List<span style="color:#f92672">&lt;</span>PrimeTask<span style="color:#f92672">&gt;</span> taskList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">int</span> start <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> end   <span style="color:#f92672">=</span> 100000000<span style="color:#f92672">;</span>

        <span style="color:#75715e">// 将 1 到 1 亿 分为 100 个区间，每个区间 1000000 个数
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> start<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> end<span style="color:#f92672">;</span> i <span style="color:#f92672">+</span><span style="color:#f92672">=</span> 1000000<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        	List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> subList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        	<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> i<span style="color:#f92672">;</span> j <span style="color:#f92672">&lt;</span> i <span style="color:#f92672">+</span> 1000000<span style="color:#f92672">;</span> j<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        		subList<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>j<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        	<span style="color:#f92672">}</span>
        	<span style="color:#75715e">// 提交一个 PrimeTask 类型的任务，返回的 future 类型是 List&lt;Integer&gt;
</span><span style="color:#75715e"></span>        	Future<span style="color:#f92672">&lt;</span>List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> future <span style="color:#f92672">=</span> executor<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PrimeTask<span style="color:#f92672">(</span>subList<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        	<span style="color:#75715e">// 然后将 future 添加到结果集
</span><span style="color:#75715e"></span>        	futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>future<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">// 迭代 future 集合，获取每个任务的执行结果，集合中的 future 顺序和上面提交任务的顺序是一致的，
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Future<span style="color:#f92672">&lt;</span>List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> f <span style="color:#f92672">:</span> futures<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        	<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        		<span style="color:#75715e">// 获取结果
</span><span style="color:#75715e"></span>        		f<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        	<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            	e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        	<span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ExecutionException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            	e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        	<span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// 关闭线程池
</span><span style="color:#75715e"></span>        executor<span style="color:#f92672">.</span><span style="color:#a6e22e">shtdown</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PrimeTask</span> <span style="color:#66d9ef">implements</span> Callable<span style="color:#f92672">&lt;</span>List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> list<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">PrimeTask</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> list<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">list</span> <span style="color:#f92672">=</span> list<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">call</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        List<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Integer i <span style="color:#f92672">:</span> list<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isPrime<span style="color:#f92672">(</span>i<span style="color:#f92672">)</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                result<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>i<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isPrime</span><span style="color:#f92672">(</span>Integer num<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>num <span style="color:#f92672">=</span><span style="color:#f92672">=</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>num <span style="color:#f92672">&lt;</span> 2 <span style="color:#f92672">|</span><span style="color:#f92672">|</span> num <span style="color:#f92672">%</span> 2 <span style="color:#f92672">=</span><span style="color:#f92672">=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span> <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 3<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span><span style="color:#a6e22e">sqrt</span><span style="color:#f92672">(</span>num<span style="color:#f92672">)</span><span style="color:#f92672">;</span> i <span style="color:#f92672">+</span><span style="color:#f92672">=</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>num <span style="color:#f92672">%</span> i <span style="color:#f92672">=</span><span style="color:#f92672">=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="-runnable-">执行 Runnable 任务</h3>
<p>那么有没有可以执行 Runnable 类型任务的类呢？其实 submit 方法也可以接收一个 Runnable 类型参数，也会返回一个 Future，只不过由于 Runnable 任务没有返回值，因此你用返回的 Future 并调用 Future.get，任务完成后只能得到一个 null。所以，这里的 Future 只能用来查看任务状态，如 Future.isDone，或者取消任务，如 Future.cancel。此外，ExecutorService 继承于 Executor 接口，Executor 有个 execute 方法，这个方法就是用于接收 Runnable 类型的任务，因此我们也可以在 ExecutorService 中使用 execute 方法提交 Runnable，即</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 实际是将 Runnable 任务委托给了父类 Executor 中的 execute
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> ExecutorService<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>Runnable task<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><p>由于本文主要侧重点在 Future，因此执行 Runnable 的例子不打算介绍了，简单总结下：</p>
<ul>
<li>ExecutorService 可以接收 Callable 和 Runnable 类型的任务，使用 submit 方法提交任务，该方法返回任务句柄 Future</li>
<li>Callable 任务执行完毕后，通过 Future.get 获取任务结果，Runnable 任务执行完后无结果</li>
</ul>
<h2 id="executorcompletionservice">ExecutorCompletionService</h2>
<p>在绝大部分场景下，ExecutorService 都可以满足我们的需要。假设现在有这样一个场景：我们向 ExecutorService 依次提交了 4 个任务 A，B，C，D，即：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ExecutorService executorService <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newFixedThreadPool</span><span style="color:#f92672">(</span>4<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
List<span style="color:#f92672">&lt;</span>Future<span style="color:#f92672">&gt;</span> futures <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>Future<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>executorService<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>A<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>executorService<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>B<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>executorService<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>C<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>executorService<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>D<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 迭代 futures 获取结果
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Future future<span style="color:#f92672">:</span>futures<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Integer result <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    
<span style="color:#f92672">}</span>
</code></pre></div><p>但是，A 任务特别耗时，而 B，C，D 任务很快就完成了，由于<code>future.get()</code>是阻塞的，因此上面在迭代 future 时，我们不得不等待 A 完成后，即第一个 future.get() 返回后，才能继续拿 B，C，D的结果。这里的主要问题是，当我们提交一个任务集合时，我们事先是不知道集合中哪个任务会先执行完，因此只能拿到一个 future 集合，这个集合的顺序和我们提交任务的顺序一致，然后依次迭代 future 取结果。因此，上面我们求质数，迭代 future 集合时，可能出现这种情况：<strong>后面某个区间的质数已经求解完毕，但前面的区间还没求解完</strong>。由于上面案例需要顺序输出质数，因此我们对 future 顺序迭代取结果。</p>
<p>再假设一个情况，如果我们提交的是下载任务：从不同的镜像源下载某个安装包。如 ubuntu.iso 文件，A 任务从国外官方官网下，B 任务从 163 镜像站下，C 任务从 ali 镜像站下，哪个任务先下载完就用哪个，并终止其他任务，这时用上述迭代方式就不合适了。</p>
<p>此时我们可以使用 <strong>ExecutorCompletionService</strong>。相比于 ExecutorService，ExecutorCompletionService 这个类提供了 take 方法，这个方法也会阻塞的等待任务集合执行，一旦集合中有完成的任务，take 就返回，注意，take 返回的是 future，也即已经完成的任务的“句柄”，这时调用 get 方法，即可拿到结果了。从描述来看，take 方法似乎跟 BlockingQueue 里的 take 方法类似，事实也确实如此，ExecutorCompletionService 是在 ExecutorService 的基础上，用一个 LinkedBlockingQueue 队列存 future。一旦有任务完成，就把该任务的 future 放入到 LinkedBlockingQueue 中，<strong>如果说
ExecutorService = incoming queue + worker threads，那么
ExecutorCompletionService = incoming queue + worker threads + output queue</strong></p>
<p>使用上，ExecutorCompletionService 也非常容易，ExecutorCompletionService 提供了一个构造方法，可以直接把 ExecutorService 包装成 ExecutorCompletionService，如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">CompletionService executorCompletionService<span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ExecutorCompletionService<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span>executorService<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><p>上面的例子用 executorCompletionService 来改写下，注释说明了问题</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ExecutorService executorService <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newFixedThreadPool</span><span style="color:#f92672">(</span>4<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
CompletionService executorCompletionService<span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ExecutorCompletionService<span style="color:#f92672">&lt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span>executorService<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
List<span style="color:#f92672">&lt;</span>Future<span style="color:#f92672">&gt;</span> futures <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>Future<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>executorCompletionService<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>A<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>executorCompletionService<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>B<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>executorCompletionService<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>C<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>executorCompletionService<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>D<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

<span style="color:#75715e">// 注意这里就不是迭代 futures 了，而是调用 executorCompletionService 的 take 方法，然后再 get
</span><span style="color:#75715e"></span><span style="color:#75715e">// 结果的顺序和提交任务的顺序可能不一致，取决于谁先执行完，就先获取谁的结果
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span> i<span style="color:#f92672">&lt;</span>futures<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span> i<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Integer result <span style="color:#f92672">=</span> executorCompletionService<span style="color:#f92672">.</span><span style="color:#a6e22e">take</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// 拿到结果，做其他处理
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// doSomeThing()
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>现在再来考虑下上述那个从不同镜像源下载安装包的场景，注释已经说明了问题</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">solve</span><span style="color:#f92672">(</span>Executor e<span style="color:#f92672">,</span> Collection<span style="color:#f92672">&lt;</span>Callable<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> solvers<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> InterruptedException <span style="color:#f92672">{</span>
	<span style="color:#75715e">// 初始化一个 ExecutorCompletionService
</span><span style="color:#75715e"></span>    CompletionService<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&gt;</span> ecs <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ExecutorCompletionService<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span>e<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#75715e">// 获得任务总数
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> solvers<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    List<span style="color:#f92672">&lt;</span>Future<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> futures <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>Future<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span><span style="color:#f92672">(</span>n<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    Result result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
    	<span style="color:#75715e">// 提交任务
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Callable<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&gt;</span> s <span style="color:#f92672">:</span> solvers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            futures<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>ecs<span style="color:#f92672">.</span><span style="color:#a6e22e">submit</span><span style="color:#f92672">(</span>s<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// 依照任务完成顺序获取结果
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> n<span style="color:#f92672">;</span> <span style="color:#f92672">+</span><span style="color:#f92672">+</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                Result r <span style="color:#f92672">=</span> ecs<span style="color:#f92672">.</span><span style="color:#a6e22e">take</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                <span style="color:#75715e">// 一旦某个任务执行完，终止循环
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>r <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    result <span style="color:#f92672">=</span> r<span style="color:#f92672">;</span>
                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>ExecutionException ignore<span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// 然后取消所有任务，对已经完成的任务，执行 cancel 无影响
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Future<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&gt;</span> f <span style="color:#f92672">:</span> futures<span style="color:#f92672">)</span>
            f<span style="color:#f92672">.</span><span style="color:#a6e22e">cancel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
        use<span style="color:#f92672">(</span>result<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>需要注意的是，上面的两个案例，我们不是迭代 Future 来拿结果，而是用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span> i<span style="color:#f92672">&lt;</span>task<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">;</span> i<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">)</span>
</code></pre></div><p>来迭代的，由于我们对结果的顺序不关心，而且 take 方法是 ExecutorCompletionService 类的，因此不能迭代 Future，而只能迭代个数，Future 个数或者任务个数，所以这里就得小心的处理 take 方法了。如果个数弄错，可能导致队列已经没有任务，但 仍然调用 take，导致一直阻塞。我们可以继承 ExecutorCompletionService，增加一个原子变量属性，每次提交一个任务，变量加 1，最终用这个变量表示任务的个数。</p>
<h2 id="heading1">总结</h2>
<ul>
<li>Runnable 执行一个不返回结果的任务，Callable 执行一个有返回结果的任务</li>
<li>可以使用 Executors 的静态方法创建线程池，由线程池来执行任务</li>
<li>submit 方法用于提交任务，并返回 Future，可以把它当成任务的句柄</li>
<li>Future 的 get 是阻塞方法，向 ExecutorService 提交多个任务，最终迭代 Future 时，结果的顺序和任务提交的顺序一致</li>
<li>ExecutorCompletionService 的 take 方法可以获取已完成的任务的 Future，是通过将任务结果放入 BlockingQueue 实现</li>
</ul>
<h4 id="heading2">参考</h4>
<ul>
<li><a href="https://dzone.com/articles/executorservice-vs">https://dzone.com/articles/executorservice-vs</a></li>
<li><a href="https://www.javaspecialists.eu/archive/Issue214.html">https://www.javaspecialists.eu/archive/Issue214.html</a></li>
</ul>
        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="http://xujimmy.com">JimmyXu</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="http://xujimmy.com/2019/05/29/java-future-and-executor.html">http://xujimmy.com/2019/05/29/java-future-and-executor.html</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/2019/04/23/git-pull-and-git-rebase.html">git pull 和 git rebase</a></li>
        
        <li><a href="/2019/04/01/docker-and-vm.html">Docker 和 KVM 虚拟机</a></li>
        
        <li><a href="/2019/03/24/java-analyzer-tools.html">Java 中常用的监控和故障处理命令行工具</a></li>
        
        <li><a href="/2018/10/12/java-concurrent.html">Java 中的同步方法</a></li>
        
        <li><a href="/2018/06/20/java-collections-generics-best-practices.html">Java 中集合和泛型最佳实践</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            没有标签
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "hbxjw119/hbxjw119.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="http://xujimmy.com">JimmyXu的小站 By JimmyXu</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://xujimmy.com">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://xujimmy.com/2021/05/29/about-painting-arts.html" title="谈谈美术绘画">谈谈美术绘画</a>
    </li>
    
    <li>
        <a href="http://xujimmy.com/2020/07/12/introduction-virtual-memory.html" title="虚拟内存简介">虚拟内存简介</a>
    </li>
    
    <li>
        <a href="http://xujimmy.com/2020/05/22/poison-detect.html" title="由病毒检测想到的一种面试题">由病毒检测想到的一种面试题</a>
    </li>
    
    <li>
        <a href="http://xujimmy.com/2019/12/11/use-proto.html" title="使用 protobuf">使用 protobuf</a>
    </li>
    
    <li>
        <a href="http://xujimmy.com/2019/09/29/computer-memory.html" title="程序员需要知道的数量级">程序员需要知道的数量级</a>
    </li>
    
    <li>
        <a href="http://xujimmy.com/2019/08/11/schedule-in-cloud.html" title="云计算中的资源调度">云计算中的资源调度</a>
    </li>
    
    <li>
        <a href="http://xujimmy.com/2019/07/21/pxe-install-os.html" title="使用 PXE 从网络安装操作系统">使用 PXE 从网络安装操作系统</a>
    </li>
    
    <li>
        <a href="http://xujimmy.com/2019/06/27/what-is-io-multiplexing.html" title="什么是 I/O 多路复用">什么是 I/O 多路复用</a>
    </li>
    
    <li>
        <a href="http://xujimmy.com/2019/05/29/java-future-and-executor.html" title="Java 中 Future 和异步任务">Java 中 Future 和异步任务</a>
    </li>
    
    <li>
        <a href="http://xujimmy.com/2019/04/23/git-pull-and-git-rebase.html" title="git pull 和 git rebase">git pull 和 git rebase</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="http://xujimmy.com/categories/life.html">Life (5)</a></li>
    
    <li><a href="http://xujimmy.com/categories/linux.html">Linux (7)</a></li>
    
    <li><a href="http://xujimmy.com/categories/math.html">Math (2)</a></li>
    
    <li><a href="http://xujimmy.com/categories/tech.html">Tech (38)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="http://xujimmy.com/tags/acme.html">acme</a>
    
    <a href="http://xujimmy.com/tags/algorithm.html">algorithm</a>
    
    <a href="http://xujimmy.com/tags/awk.html">awk</a>
    
    <a href="http://xujimmy.com/tags/book.html">book</a>
    
    <a href="http://xujimmy.com/tags/collection.html">collection</a>
    
    <a href="http://xujimmy.com/tags/cookie.html">Cookie</a>
    
    <a href="http://xujimmy.com/tags/csdn.html">csdn</a>
    
    <a href="http://xujimmy.com/tags/design-pattern.html">design pattern</a>
    
    <a href="http://xujimmy.com/tags/docker.html">docker</a>
    
    <a href="http://xujimmy.com/tags/find.html">find</a>
    
    <a href="http://xujimmy.com/tags/fpm.html">fpm</a>
    
    <a href="http://xujimmy.com/tags/gevent.html">gevent</a>
    
    <a href="http://xujimmy.com/tags/git.html">git</a>
    
    <a href="http://xujimmy.com/tags/go.html">go</a>
    
    <a href="http://xujimmy.com/tags/grafana.html">grafana</a>
    
    <a href="http://xujimmy.com/tags/grep.html">grep</a>
    
    <a href="http://xujimmy.com/tags/http.html">http</a>
    
    <a href="http://xujimmy.com/tags/httpie.html">httpie</a>
    
    <a href="http://xujimmy.com/tags/https.html">HTTPS</a>
    
    <a href="http://xujimmy.com/tags/influxdb.html">influxdb</a>
    
    <a href="http://xujimmy.com/tags/java.html">Java</a>
    
    <a href="http://xujimmy.com/tags/jvm.html">JVM</a>
    
    <a href="http://xujimmy.com/tags/kvm.html">KVM</a>
    
    <a href="http://xujimmy.com/tags/linux.html">linux</a>
    
    <a href="http://xujimmy.com/tags/lnmp.html">lnmp</a>
    
    <a href="http://xujimmy.com/tags/math.html">math</a>
    
    <a href="http://xujimmy.com/tags/monitor.html">monitor</a>
    
    <a href="http://xujimmy.com/tags/mq.html">MQ</a>
    
    <a href="http://xujimmy.com/tags/mysql.html">mysql</a>
    
    <a href="http://xujimmy.com/tags/nginx.html">nginx</a>
    
    <a href="http://xujimmy.com/tags/phantomjs.html">PhantomJS</a>
    
    <a href="http://xujimmy.com/tags/php.html">php</a>
    
    <a href="http://xujimmy.com/tags/python.html">python</a>
    
    <a href="http://xujimmy.com/tags/redis.html">redis</a>
    
    <a href="http://xujimmy.com/tags/session.html">Session</a>
    
    <a href="http://xujimmy.com/tags/shell.html">shell</a>
    
    <a href="http://xujimmy.com/tags/sort.html">sort</a>
    
    <a href="http://xujimmy.com/tags/tcp.html">tcp</a>
    
    <a href="http://xujimmy.com/tags/web.html">web</a>
    
    <a href="http://xujimmy.com/tags/xargs.html">xargs</a>
    
    <a href="http://xujimmy.com/tags/zookeeper.html">zookeeper</a>
    
    <a href="http://xujimmy.com/tags/zsh.html">zsh</a>
    
    <a href="http://xujimmy.com/tags/%E4%B9%A6%E5%8D%95.html">书单</a>
    
    <a href="http://xujimmy.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6.html">二进制</a>
    
    <a href="http://xujimmy.com/tags/%E5%85%AC%E4%BC%97%E5%8F%B7.html">公众号</a>
    
    <a href="http://xujimmy.com/tags/%E5%85%AC%E5%BC%8F.html">公式</a>
    
    <a href="http://xujimmy.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F.html">分布式系统</a>
    
    <a href="http://xujimmy.com/tags/%E5%8C%97%E4%BA%AC.html">北京</a>
    
    <a href="http://xujimmy.com/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.html">操作系统</a>
    
    <a href="http://xujimmy.com/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97.html">消息队列</a>
    
    <a href="http://xujimmy.com/tags/%E7%BD%91%E7%BB%9C.html">网络</a>
    
    <a href="http://xujimmy.com/tags/%E8%89%BA%E6%9C%AF%E7%BE%8E%E6%9C%AF%E4%B8%AA%E4%BA%BA.html">艺术，美术，个人</a>
    
    <a href="http://xujimmy.com/tags/%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98.html">虚拟内存</a>
    
    <a href="http://xujimmy.com/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA.html">虚拟机</a>
    
    <a href="http://xujimmy.com/tags/%E8%AE%B0%E8%B4%A6.html">记账</a>
    
    <a href="http://xujimmy.com/tags/%E9%98%BF%E9%87%8C%E4%BA%91.html">阿里云</a>
    
    <a href="http://xujimmy.com/tags/%E9%9A%8F%E6%83%B3.html">随想</a>
    
    <a href="http://xujimmy.com/tags/%E9%9D%A2%E8%AF%95.html">面试</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://xujimmy.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>